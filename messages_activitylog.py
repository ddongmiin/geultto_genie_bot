import os
from core.slack import SlackMessageRetriever
from core.bigquery import BigqueryProcessor


slack_app = SlackMessageRetriever(env_name="SLACK_TOKEN_BOT")
bigquery_client = BigqueryProcessor(
    env_name="GOOGLE_APPLICATION_CREDENTIALS", database_id="geultto_9th"
)

user_pd = bigquery_client.run_query_to_dataframe(
    query="""
    select distinct *
    from geultto.geultto_9th.send_message_final_view_test_v3
     where userid IN ('U066SBYNGE5' , 'U066AQSBRPF', 'U066QLYFNKX')
    """
)

submit_count_pd = bigquery_client.run_query_to_dataframe(
    """
    select *
    from geultto.geultto_9th.post_submit_status_v3
    where userid IN ('U066SBYNGE5' , 'U066AQSBRPF')
    order by userid, issues
    """
)

for _, row in user_pd.iterrows():
    temp_pd = submit_count_pd.loc[(submit_count_pd.name == row[1])] 
    temp_pd = temp_pd.sort_values('issues')
    submit_text = ''
    for _, row1 in temp_pd.iterrows():
        if row1[3] == 'ì œì¶œì™„ë£Œ': 
            submit_text = submit_text + "ğŸ“¬  "
        elif row1[3] == 'íŒ¨ìŠ¤ì™„ë£Œ':
            submit_text = submit_text + "ğŸ“­  "
        else: 
            submit_text = submit_text + "ğŸ’¸  "
    print(submit_text)
    
    #í™œë™ ì±„ë„
    channel_1 = row[8].split(',')[0]
    channel_2 = row[8].split(',')[1]
    channel_3 = row[8].split(',')[2]

    #ë‚¨ì€ ì˜ˆì‚°ì— ë”°ë¥¸ ì¶”ê°€ ë¬¸êµ¬ ì‘ì„±
    if row[15] <= 50000:
        final_ment = 'ì•— ì´ë²ˆ ê¸°ìˆ˜ë™ì•ˆì— ê¸€ì„ ì œì¶œí•˜ì‹¤ ì—¬ìœ ê°€ ì—†ìœ¼ì…¨êµ°ìš”:) ë‚¨ì€ 1ë‹¬ë™ì•ˆì´ë¼ë„ 2ë²ˆì˜ ê¸€ ì œì¶œ ê¸°íšŒë¥¼ ì¡ì•„ë³´ì‹œëŠ”ê±´ ì–´ë– ì‹¤ê¹Œìš”~?!'
    else:
        final_ment = ''

    #ì»¤í”¼ì±— íšŸìˆ˜ì— ë”°ë¥¸ ì¶”ê°€ ë¬¸êµ¬ ì‘ì„±
    if row[17] == 0:
        coffee_text = 'ì•— ì´ë²ˆ ê¸°ìˆ˜ë™ì•ˆì— ì»¤í”¼ì±—ì„ ì§„í–‰í•  ì—¬ìœ ê°€ ì—†ìœ¼ì…¨êµ°ìš”:) ë‚¨ì€ 1ë‹¬ë™ì•ˆì´ë¼ë„ ì£¼ìš” í™œë™ ì±„ë„ í˜¹ì€ ì†í•˜ì‹  ì±„ë„ì—ì„œ ì»¤í”¼ì±—ì„ ì§„í–‰í•´ë³´ì‹œëŠ”ê±´ ì–´ë– ì‹¤ê¹Œìš”~?!'
    elif row[17] == 1:
        coffee_text = 'í•œë²ˆì˜ ì»¤í”¼ì±—ì„ ì§„í–‰í•˜ì…¨êµ°ìš”. ë‚¨ì€ ê¸°ê°„ë™ì•ˆ í•œë²ˆì˜ ì»¤í”¼ì±—ì„ ë” ì§„í–‰í•´ì„œ 2ë²ˆ ì±„ì›Œë³´ì‹œëŠ”ê±¸ ì–´ë– ì‹¤ê¹Œìš”~?!'
    elif row[17] == 2:
        coffee_text = '2ë²ˆì˜ ì»¤í”¼ì±—ì„ ëª¨ë‘ ì§„í–‰í•˜ì…¨ë‹¤ë‹ˆ ë©‹ìˆìŠµë‹ˆë‹¤! ê¸€ë„ ì»¤í”¼ì±—ë„ ì—´ì‹¬íˆ í™œë™í•˜ì‹œëŠë¼ ê³ ìƒë§ìœ¼ì…¨ì–´ìš”~'
    else:
        coffee_text = f'ì´ë²ˆ 9ê¸°ë™ì•ˆ {row[17]}ë²ˆì˜ ì»¤í”¼ì±—ì„ ì§„í–‰í•˜ì…¨ë‹¤ë‹ˆ ë©‹ìˆìŠµë‹ˆë‹¤~ ë‹¤ìŒ ê¸°ìˆ˜ì—ì„œë„ ì—´ì‹¬íˆ ì°¸ì—¬í•´ì£¼ì‹¤ê±°ì£ ~?!'
    

    #íŒ¨ìŠ¤ê¶Œì— ë”°ë¥¸ ë¬¸êµ¬ ì‘ì„±
    if row[18] == 2:
        pass_cnt=0 
        pass_text = 'íŒ¨ìŠ¤ê¶Œì„ í•˜ë‚˜ë„ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ì…¨ë‹¤ë‹ˆ ë©‹ìˆìŠµë‹ˆë‹¤! ë¶€ì§€ëŸ°íˆ ê¸€ì„ ì“°ì‹  ì§€ë‚œ 5ê°œì›”ë™ì•ˆ ê³ ìƒë§ìœ¼ì…¨ì–´ìš”~'
    elif row[18] == 1:
        pass_cnt=1
    else:
        pass_cnt=2
        

    text = f"""
ì•ˆë…•í•˜ì„¸ìš”! {row[1]}ë‹˜! ì¢‹ì€ í•˜ë£¨ì…ë‹ˆë‹¤â˜€ï¸
í•œë‹¬ë™ì•ˆ ì—°ì¥ì „ì„ ë‹¬ë¦´ ì—¬ëŸ¬ë¶„ë“¤ì„ ìœ„í•´ ì§€ë‚œ 5ê°œì›” ë™ì•ˆì˜ í™œë™ë‚´ì—­ì„ ì •ë¦¬í•´ë³´ì•˜ìŠµë‹ˆë‹¤.ğŸ‘
\n
> ğŸ” *{row[14]}ë‹˜ì˜ í™œë™ ìš”ì•½* 
    â€¢ {row[14]}ë‹˜ì€ ì´ `{row[3]}`ê°œì˜ ê¸€ê³¼ `{row[4]}`ê°œì˜ ì“°ë ˆë“œ `{row[5]}`ê°œì˜ ì´ëª¨ì§€ë¥¼ ë‚¨ê²¨ì£¼ì…¨ì–´ìš”. 
    â€¢ ì§€ê¸ˆê¹Œì§€ í™œë™í•œ ì–‘ì„ ë³´ë‹ˆ ì–´ë–¤ ë§ˆìŒì´ ë“œì‹œë‚˜ìš”? ì—°ì¥ëœ í•œë‹¬ë™ì•ˆ {row[14]}ë‹˜ì˜ ê¸€ê³¼ ìƒê°ì„ ê¸€ë˜ì— ë‚¨ê²¨ë³´ì‹œëŠ”ê±´ ì–´ë– ì‹¤ê¹Œìš”?!ğŸ™
\n
> ğŸ“ *{row[14]}ë‹˜ì˜ ê¸€ ì œì¶œ ë‚´ì—­*
    â€¢ {submit_text} ___ ğŸ“¬(ì œì¶œì™„ë£Œ), ğŸ“­(íŒ¨ìŠ¤), ğŸ’¸(ì°¨ê°)
    â€¢ {row[14]}ë‹˜ì€ ì´ `{row[19]}`íšŒ ì œì¶œ ì™„ë£Œ, `{pass_cnt}`íšŒ íŒ¨ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì…¨ì–´ìš”. 
    â€¢ ì´ë ‡ê²Œ ë³´ë‹ˆ 5ë‹¬ì´ë€ ì‹œê°„ì´ ì—„ì²­ ë¹¨ë¦¬ ê°„ê²ƒ ê°™ì•„ìš”! ì´ë ‡ê²Œ ëë‚´ê¸° ì•„ì‰½ì§€ ì•Šë‚˜ìš”? ì¶”ê°€ë¡œ ê¸€ì„ ì œì¶œí•˜ì…”ì„œ í™˜ê¸‰ê¸ˆì„ ë°›ì•„ê°€ì„¸ìš©~! ê°€ë³´ìê³ ~~ğŸ’ªğŸ»ğŸ’ªğŸ»
\n
> ğŸ¾ *{row[14]}ë‹˜ì˜ ì£¼ìš” í™œë™ ì±„ë„*
        1ìœ„: {channel_1}
        2ìœ„: {channel_2}
        3ìœ„: {channel_3}
   â€¢ ì§€ê¸ˆê¹Œì§€ í•´ë‹¹ ì±„ë„ì— ì—¬ëŸ¬ë¶„ë“¤ì˜ ë°œìì·¨ë¥¼ ë‚¨ê²¨ì£¼ì…”ì„œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤ğŸ™‡ğŸ»â€â™€ï¸ 
   â€¢ ë‚¨ì€ í•œë‹¬ë™ì•ˆ {row[14]}ë‹˜ì´ ì†í•œ {row[11]}ì—ì„œ ë§ˆì§€ë§‰ìœ¼ë¡œ ì•ˆë¶€ì¸ì‚¬ë“¤ì„ ë‚˜ëˆ ë³´ì‹œëŠ”ê±´ ì–´ë–¨ê¹Œìš”~?
\n
> ğŸ‘« *{row[14]}ë‹˜ì˜ í™˜ìƒì˜ ì§ê¶*
    â€¢ ê¸€ë˜ 9ê¸°ë™ì•ˆ ë‚˜ì™€ í•¨ê»˜í•´ì¤€ í™˜ìƒì˜ ì§ê¿ì„ ì†Œê°œí•´ë“œë¦´ê²Œìš”. 
        ğŸ’ë‚´ê°€ ë§ì´ ê´€ì‹¬ì„ ë³´ì˜€ë˜ ì§ê¿ğŸ’ : `{row[13]}`
        ğŸ’˜ë‚˜ì—ê²Œ ë§ì€ ê´€ì‹¬ì„ ë³´ë‚´ì¤€ ì§ê¿ğŸ’˜ : `{row[12]}`
\n 
> â˜•ï¸ *{row[14]}ë‹˜ì˜ ì»¤í”¼ì±— ë‚´ì—­*
    â€¢ {row[14]}ë‹˜ì˜ ì»¤í”¼ì±— íšŸìˆ˜ëŠ” `{row[17]}`ì…ë‹ˆë‹¤.
    â€¢ {coffee_text}
    â€¢ ê¸€ë˜ê°€ ëë‚˜ê¸°ì „ì— í™˜ìƒì˜ ì§ê¶ìœ¼ë¡œ ì„ ì •ëœ ë¶„ë“¤ê³¼ ì»¤í”¼ì±—ì„ í•´ë³´ì‹œë©´ ì–´ë– ì‹¤ê¹Œìš”?â˜•ï¸
\n 
{final_ment} 
ê¸€ë˜ 9ê¸°ë™ì•ˆ {row[9]}ë¡œì„œ í™œë™í•˜ì‹œë©° ì¢‹ì€ ê¸€ ë‚¨ê²¨ì£¼ì…”ì„œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.
ë‚¨ì€ ì—°ì¥ì „ë„ ì—´ì‹¬íˆ ì°¸ì—¬í•´ ì£¼ì‹¤ê±°ì£ ?! ê·¸ëŸ¼ {row[14]}ë‹˜ì˜ ë‚¨ì€ ê¸€ë˜ í™œë™ë„ ì‘ì›í•˜ë©° ë¬¼ëŸ¬ê°€ë³´ê² ìŠµë‹ˆë‹¤. ì €í¬ëŠ” ê¸€ë˜ 10ê¸°ì—ì„œ ë” ë°œì „ëœ ëª¨ìŠµìœ¼ë¡œ ë§Œë‚˜ìš”!
    """
    print(row[1])

    slack_app.message_for_private(user=row[0], text=text)
