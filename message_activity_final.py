import os
import time
from core.slack import SlackMessageRetriever
from core.bigquery import BigqueryProcessor

slack_app = SlackMessageRetriever(env_name="SLACK_TOKEN_BOT")
bigquery_client = BigqueryProcessor(
    env_name="GOOGLE_APPLICATION_CREDENTIALS", database_id="geultto_9th"
)

user_pd = bigquery_client.run_query_to_dataframe(
    query="""
    select distinct *
    from geultto.geultto_9th.send_message_final_view_test_v3
    """
).fillna(
    0
)  # ì˜ˆì¹˜ê¸ˆ ì‹œíŠ¸ì— ê¸°ë¡ì´ ì—†ëŠ” ê²½ìš° 0ìœ¼ë¡œ ì²˜ë¦¬

for _, row in user_pd.iterrows():
    temp_pd = submit_count_pd.loc[(submit_count_pd.name == row[1])]
    temp_pd = temp_pd.sort_values("issues")
    submit_text = ""
    for _, row1 in temp_pd.iterrows():
        if row1[3] == "ì œì¶œì™„ë£Œ":
            submit_text = submit_text + "ğŸ“¬  "
        elif row1[3] == "íŒ¨ìŠ¤ì™„ë£Œ":
            submit_text = submit_text + "ğŸ“­  "
        else:
            submit_text = submit_text + "ğŸ’¸  "
    print(submit_text)

    if row[15] <= 50000:
        final_ment = "ì•— ì´ë²ˆ ê¸°ìˆ˜ë™ì•ˆì— ê¸€ì„ ì œì¶œí•˜ì‹¤ ì—¬ìœ ê°€ ì—†ìœ¼ì…¨êµ°ìš”:) ë‚¨ì€ 1ë‹¬ë™ì•ˆì´ë¼ë„ 2ë²ˆì˜ ê¸€ ì œì¶œ ê¸°íšŒë¥¼ ì¡ì•„ë³´ì‹œëŠ”ê±´ ì–´ë– ì‹¤ê¹Œìš”~?!"
    else:
        final_ment = ""

    # ì»¤í”¼ì±— íšŸìˆ˜ì— ë”°ë¥¸ ì¶”ê°€ ë¬¸êµ¬ ì‘ì„±
    if row[17] == 0:
        coffee_text = "ì•— ì´ë²ˆ ê¸°ìˆ˜ë™ì•ˆì— ì»¤í”¼ì±—ì„ ì§„í–‰í•  ì—¬ìœ ê°€ ì—†ìœ¼ì…¨êµ°ìš”:) ë‚¨ì€ 1ë‹¬ë™ì•ˆì´ë¼ë„ ì£¼ìš” í™œë™ ì±„ë„ í˜¹ì€ ì†í•˜ì‹  ì±„ë„ì—ì„œ ì»¤í”¼ì±—ì„ ì§„í–‰í•´ë³´ì‹œëŠ”ê±´ ì–´ë– ì‹¤ê¹Œìš”~?!"
    elif row[17] == 1:
        coffee_text = "í•œë²ˆì˜ ì»¤í”¼ì±—ì„ ì§„í–‰í•˜ì…¨êµ°ìš”. ë‚¨ì€ ê¸°ê°„ë™ì•ˆ í•œë²ˆì˜ ì»¤í”¼ì±—ì„ ë” ì§„í–‰í•´ì„œ 2ë²ˆ ì±„ì›Œë³´ì‹œëŠ”ê±¸ ì–´ë– ì‹¤ê¹Œìš”~?!"
    elif row[17] == 2:
        coffee_text = "2ë²ˆì˜ ì»¤í”¼ì±—ì„ ëª¨ë‘ ì§„í–‰í•˜ì…¨ë‹¤ë‹ˆ ë©‹ìˆìŠµë‹ˆë‹¤! ê¸€ë„ ì»¤í”¼ì±—ë„ ì—´ì‹¬íˆ í™œë™í•˜ì‹œëŠë¼ ê³ ìƒë§ìœ¼ì…¨ì–´ìš”~"
    else:
        coffee_text = f"ì´ë²ˆ 9ê¸°ë™ì•ˆ {row[17]}ë²ˆì˜ ì»¤í”¼ì±—ì„ ì§„í–‰í•˜ì…¨ë‹¤ë‹ˆ ë©‹ìˆìŠµë‹ˆë‹¤~ ë‹¤ìŒ ê¸°ìˆ˜ì—ì„œë„ ì—´ì‹¬íˆ ì°¸ì—¬í•´ì£¼ì‹¤ê±°ì£ ~?!"

    # íŒ¨ìŠ¤ê¶Œì— ë”°ë¥¸ ë¬¸êµ¬ ì‘ì„±
    if row[18] == 2:
        pass_cnt = 0
        pass_text = "íŒ¨ìŠ¤ê¶Œì„ í•˜ë‚˜ë„ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ì…¨ë‹¤ë‹ˆ ë©‹ìˆìŠµë‹ˆë‹¤! ë¶€ì§€ëŸ°íˆ ê¸€ì„ ì“°ì‹  ì§€ë‚œ 5ê°œì›”ë™ì•ˆ ê³ ìƒë§ìœ¼ì…¨ì–´ìš”~"
    elif row[18] == 1:
        pass_cnt = 1
    else:
        pass_cnt = 2

    text = f"""
ì•ˆë…•í•˜ì„¸ìš”! {row[1]}ë‹˜! ì¢‹ì€ í•˜ë£¨ì…ë‹ˆë‹¤â˜€ï¸
ê·¸ê°„ í™œë™ì€ ì–´ë– ì…¨ë‚˜ìš”? 400ëª…ê°€ëŸ‰ì´ë‚˜ ë˜ëŠ” ì»¤ë®¤ë‹ˆí‹°ì— ì°¸ì—¬ í•´ì£¼ì‹  ê²ƒë§Œìœ¼ë¡œë„ í° ìš©ê¸°ë¥¼ ë‚´ì£¼ì‹  ê²ƒ ê°™ì•„ ë„ˆë¬´ë‚˜ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤. 
ê¸€ë˜ 9ê¸°ë¥¼ ë§ˆë¬´ë¦¬í•˜ë©° 11ì›” 27ì¼ë¶€í„° 4ì›” 14ì¼ê¹Œì§€ ì•½ 5ê°œì›”ê°„, ì–´ë–¤ í™œë™ì„ í•˜ì…¨ëŠ”ì§€ ë³´ì‹¤ ìˆ˜ ìˆë„ë¡ ë°ì´í„°ë¥¼ ì •ë¦¬í•´ ë³´ì•˜ìŠµë‹ˆë‹¤.ğŸ‘
ê°™ì´ ë°ì´í„°ë¥¼ ë³´ë©° ì²˜ìŒ ì°¸ì—¬í–ˆë˜ ë§ˆìŒê°€ì§ê³¼ ì•ìœ¼ë¡œì˜ ëª©í‘œì— ëŒ€í•´ì„œ ìƒê°í•´ ë´ìš”:) ì°¸ì—¬í•´ ì£¼ì…”ì„œ ë‹¤ì‹œ í•œë²ˆ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤. ğŸ™‡ğŸ»â€ 
\n
> ğŸ” *{row[14]}ë‹˜ì˜ í™œë™ ìš”ì•½* 
    â€¢ {row[14]}ë‹˜ì€ ì´ `{row[3]}`ê°œì˜ í¬ìŠ¤íŠ¸ì™€ `{row[4]}`ê°œì˜ ì“°ë ˆë“œ `{row[5]}`ê°œì˜ ì´ëª¨ì§€ë¥¼ ë‚¨ê²¨ì£¼ì…¨ì–´ìš”. 
    â€¢ ê¸€ë˜ì—ì„œ í™œë™í•˜ì‹œë©´ì„œ ì–´ë–¤ ì ì„ ëŠë¼ì…¨ë‚˜ìš”? ìµœì´ˆì— ë‹¤ì§í–ˆë˜ ë‚´ìš©ì„ ì˜ ì§€ì¼°ëŠ”ì§€ í˜¹ì€ ê·¸ ì™¸ì— ì–´ë–¤ ê²½í—˜ì„ í–ˆì„ì§€ ê¶ê¸ˆí•˜ë„¤ìš”. ì´ëŸ° ë‚´ìš©ë“¤ì„ ë‹´ì•„ {row[14]}ë‹˜ì˜ íšŒê³  ê¸€ì„ ì‘ì„±í•´ë³´ì‹œë©´ ì–´ë–¨ê¹Œìš”? ë‹¤ìŒ ê¸°ìˆ˜ë¥¼ í•˜ê³  ì‹¶ë‹¤ë©´ ë‹¤ìŒ ê¸°ìˆ˜ë¥¼ ìœ„í•œ ë‹¤ì§ì„ ë¯¸ë¦¬ ì‘ì„±í•´ë„ ì¢‹ì„ ê²ƒ ê°™ì•„ìš”.ğŸ™
\n
> ğŸ“ *{row[14]}ë‹˜ì˜ ê¸€ ì œì¶œ ë‚´ì—­*
    â€¢ {submit_text} ___ ğŸ“¬(ì œì¶œì™„ë£Œ), ğŸ“­(íŒ¨ìŠ¤), ğŸ’¸(ì°¨ê°)
    â€¢ {row[14]}ë‹˜ì€ ì´ `{row[19]}`íšŒ ì œì¶œ ì™„ë£Œ, `{pass_cnt}`íšŒ íŒ¨ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì…¨ì–´ìš”. 
    â€¢ OT ë•Œ ë“¤ì€ê²ƒ ì²˜ëŸ¼ 5ë‹¬ì´ ì •ë§ ë¹ ë¥´ê²Œ ì§€ë‚˜ê°”ì–´ìš”! ì—°ì¥ëœ ê¸°ê°„ì— ê¸€ì„ ì œì¶œí•˜ì…”ì„œ ì¶”ê°€ í™˜ê¸‰ê¸ˆ ë°›ì•„ê°€ì‹œê³ , ìì‹ ì˜ ìƒê°ì„ ì •ë¦¬í•´ë³´ì„¸ìš”. ì‹œì‘ë§Œí¼ì´ë‚˜ ëë§ºìŒì„ ì˜í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•œ ê²ƒ ê°™ì•„ìš”. ë‚¨ì€ ê¸°ê°„ ì €í¬ ì—´ì‹¬íˆ í•´ë³´ì•„ìš”.ğŸ’ªğŸ»ğŸ’ªğŸ»
\n
> ğŸ¾ *{row[14]}ë‹˜ì˜ ì£¼ìš” í™œë™ ì±„ë„*
        {row[8]}
   â€¢ ì§€ê¸ˆê¹Œì§€ í•´ë‹¹ ì±„ë„ì— ì—¬ëŸ¬ë¶„ë“¤ì˜ ë°œìì·¨ë¥¼ ë‚¨ê²¨ì£¼ì…”ì„œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.ğŸ™‡ğŸ»â€â™€ï¸ 
   â€¢ ë‚¨ì€ í•œë‹¬ë™ì•ˆ {row[14]}ë‹˜ì´ ì†í•œ `{row[11]}`ì—ì„œ ì¸ì‚¬ë¥¼ ë‚˜ëˆ ë³´ë©´ ì–´ë–¨ê¹Œìš”?
\n
> ğŸ‘« *{row[14]}ë‹˜ì˜ í™˜ìƒì˜ ì§ê¶*
    â€¢ ê¸€ë˜ 9ê¸°ë™ì•ˆ ë‚˜ì™€ í•¨ê»˜í•´ì¤€ í™˜ìƒì˜ ì§ê¿ì„ ì†Œê°œí•´ë“œë¦´ê²Œìš”. ê°ì‚¬ì˜ í‘œí˜„ì„ ë‚˜ëˆ ë³´ì„¸ìš”:)
        ğŸ’ë‚´ê°€ ë§ì´ ê´€ì‹¬ì„ ë³´ì˜€ë˜ ì§ê¿ğŸ’ : `{row[13]}`
        ğŸ’˜ë‚˜ì—ê²Œ ë§ì€ ê´€ì‹¬ì„ ë³´ë‚´ì¤€ ì§ê¿ğŸ’˜ : `{row[12]}`
\n 
> â˜•ï¸ *{row[14]}ë‹˜ì˜ ì»¤í”¼ì±— ë‚´ì—­*
    â€¢ {row[14]}ë‹˜ì˜ ì»¤í”¼ì±— íšŸìˆ˜ëŠ” `{row[17]}`ë²ˆ ì…ë‹ˆë‹¤.
    â€¢ {coffee_text} ìš°ë¦¬ì˜ ì¸ì—°ì€ ì§€ê¸ˆë¶€í„° ì‹œì‘ì´ê¸°ì— ì•ìœ¼ë¡œë„ ì»¤í”¼ì±—ì„ í•˜ë©° ì¸ì—°ì„ ì´ì–´ë‚˜ê°€ìš”.
\n 
{final_ment} 
ê¸€ë˜ 9ê¸°ë™ì•ˆ {row[9]}ë¡œì„œ í™œë™í•˜ì‹œë©° ì¢‹ì€ ê¸€ ë‚¨ê²¨ì£¼ì…”ì„œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.
ë‚¨ì€ ì—°ì¥ì „ë„ ì—´ì‹¬íˆ ì°¸ì—¬ ë¶€íƒë“œë ¤ìš”. ê·¸ëŸ¼ ì € ë°ë‹¬ë¶€ëŠ” {row[14]}ë‹˜ì˜ ë‚¨ì€ ê¸€ë˜ í™œë™ë„ ì‘ì›í•˜ë©° ë¬¼ëŸ¬ê°€ë³´ê² ìŠµë‹ˆë‹¤. 
ë°ë‹¬ë¶€ë¥¼ ë§ì¶¤ Push ì‹œìŠ¤í…œìœ¼ë¡œ ë§Œë“¤ê³  ìˆëŠ”ë°, ì—¬ëŸ¬ë¶„ë“¤ì˜ ì˜ê²¬ì´ ê¶ê¸ˆí•´ìš”. ê°„ë‹¨í•œ ì„¤ë¬¸ì´ë‹ˆ ì—¬ëŸ¬ë¶„ë“¤ì˜ ê´€ì‹¬ê³¼ ì°¸ì—¬ë¥¼ ë¶€íƒë“œë¦½ë‹ˆë‹¤~ğŸ™‡ğŸ»â€â™€ï¸ 
ê·¸ëŸ¼ ì €í¬ëŠ” ê¸€ë˜ 10ê¸°ì—ì„œ ë˜ ë§Œë‚˜ìš”!!
\n
ë°ë‹¬ë¶€ ì˜ê²¬ ì²­ì·¨í•¨ : https://bit.ly/3w9spg2
    """
    print(row[1])
    print(text)

    # í˜¹ì‹œ ìˆì„ ì—ëŸ¬ë¡œ ì¸í•´ ë©”ì‹œì§€ê°€ ì¤‘ê°„ì— ë©ˆì¶œ ê²½ìš°, ì¤‘ë‹¨ ì§€ì ë¶€í„° ë‹¤ì‹œ ë°œì†¡ í•  ìˆ˜ ìˆë„ë¡. í•´ë‹¹ ì…€ ì‹¤í–‰ ì‹œ, ì¤‘ë‹¨ì§€ì ë¶€í„° ë‹¤ì‹œ ë°œì†¡
    user_pd = user_pd.drop(user_pd[user_pd["name"] == row[1]].index)
    # slack_app.message_for_private(user=row[0], text=text)
